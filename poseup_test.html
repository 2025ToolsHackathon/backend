<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoseUp ì±Œë¦°ì§€ í…ŒìŠ¤íŠ¸ (Aë‹˜ìš©)</title>
    <!-- 1. Tailwind CSS (ìŠ¤íƒ€ì¼ë§) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. MediaPipe (ì† ì œìŠ¤ì²˜ ì¸ì‹ ML ëª¨ë¸) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm/vision_bundle.js"></script>
    
    <!-- 3. Firebase SDK (Aë‹˜ì˜ ë°±ì—”ë“œ API í˜¸ì¶œìš©) -->
    <script type="module">
        // Firebase SDK ìŠ¤í¬ë¦½íŠ¸ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        // --- Firebase ì„¤ì • (Aë‹˜ì´ í•˜ì‹¤ ì¼ 1) ---
        // Aë‹˜ì˜ ì‹¤ì œ FIREBASE CONFIG ì½”ë“œê°€ ì´ ìœ„ì¹˜ì— ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.
        
        const firebaseConfig = {
            apiKey: "AIzaSyCIfDgy0PmbxGnlMUDF8FI2_VgR1cB2k6M",
            authDomain: "tools-35890.firebaseapp.com",
            projectId: "tools-35890",
            storageBucket: "tools-35890.firebasestorage.app",
            messagingSenderId: "974087577109",
            appId: "1:974087577109:web:c66b287c72d17389f2781c",
            measurementId: "G-7B18CELE21"
        };

        // --- ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
        let firebaseApp, auth, functions;
        let gestureRecognizer; // MediaPipe ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤
        let webcamRunning = false;
        let missionLabel = null; // Aë‹˜ì˜ 'getTodayMission' APIë¡œ ë°›ì•„ì˜¬ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ (ì˜ˆ: "Thumb_Up")
        let currentGesture = null; // ML ëª¨ë¸ì´ ê°ì§€í•œ í˜„ì¬ ì œìŠ¤ì²˜
        let challengeSuccess = false; // ì±Œë¦°ì§€ ì„±ê³µ ì—¬ë¶€

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const video = document.getElementById("webcam");
        const statusText = document.getElementById("statusText");
        const missionText = document.getElementById("missionText");
        const currentGestureText = document.getElementById("currentGestureText");
        const loginBtn = document.getElementById("loginBtn");
        const startBtn = document.getElementById("startBtn");

        // --- 1. Firebase ì´ˆê¸°í™” ---
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            // Functionsì˜ ë¦¬ì „ ì„¤ì •. Aë‹˜ì€ ì„œìš¸('asia-northeast3') ë˜ëŠ” ê¸°ë³¸ ìœ„ì¹˜('us-central1')ì— ë§ê²Œ ì„¤ì •í•˜ì„¸ìš”.
            functions = getFunctions(firebaseApp, "asia-northeast3"); 
            console.log("Firebaseê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
            statusText.textContent = "Firebase ì„¤ì •(firebaseConfig)ì„ í™•ì¸í•˜ì„¸ìš”!";
        }

        // --- 2. ML ëª¨ë¸ (MediaPipe) ì´ˆê¸°í™” ---
        // Aë‹˜ì´ ì›í•˜ì‹  "ì† ì œìŠ¤ì²˜ ì¸ì‹" ëª¨ë¸ì„ ë¡œë“œí•©ë‹ˆë‹¤.
        const { GestureRecognizer, FilesetResolver, RunningMode } = window.MediaPipeTasksVision;

        const createGestureRecognizer = async () => {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            // ì •ì‹ Gesture Recognizer ëª¨ë¸ ê²½ë¡œ (ì‚¬ì „ì— ì •ì˜ëœ 7ê°€ì§€ ì œìŠ¤ì²˜ ì¸ì‹ ê°€ëŠ¥)
            const modelAssetPath = "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task";

            gestureRecognizer = await GestureRecognizer.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: modelAssetPath,
                    // ML ì¹©ì…‹ì´ ìˆë‹¤ë©´ GPU ì‚¬ìš© (ì„±ëŠ¥ í–¥ìƒ)
                    delegate: "GPU" 
                },
                runningMode: RunningMode.VIDEO, // ì›¹ìº (ë¹„ë””ì˜¤) ëª¨ë“œë¡œ ì‹¤í–‰
                numHands: 1 // ì† 1ê°œë§Œ ì¸ì‹
            });
            statusText.textContent = "ML ëª¨ë¸ ë¡œë“œ ì™„ë£Œ. ë¡œê·¸ì¸ í›„ ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•˜ì„¸ìš”.";
            console.log("Gesture recognizer ëª¨ë¸ ë¡œë“œ ì™„ë£Œ.");
        };
        // í˜ì´ì§€ê°€ ì—´ë¦¬ìë§ˆì ëª¨ë¸ ë¡œë“œ ì‹œì‘
        createGestureRecognizer();


        // --- 3. Google ë¡œê·¸ì¸ ê¸°ëŠ¥ ---
        const login = async () => {
            if (!auth) return;
            statusText.textContent = "Google ë¡œê·¸ì¸ ì‹œë„ ì¤‘...";
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                console.log("ë¡œê·¸ì¸ ì„±ê³µ:", result.user.displayName);
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                statusText.textContent = "Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” íŒì—… ì°¨ë‹¨ í™•ì¸)";
            }
        };

        // --- 4. ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ë¡œê·¸ì¸ë¨
                loginBtn.style.display = "none";
                startBtn.style.display = "block";
                statusText.textContent = `${user.displayName}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•˜ì„¸ìš”.`;
            } else {
                // ë¡œê·¸ì•„ì›ƒë¨
                loginBtn.style.display = "block";
                startBtn.style.display = "none";
                statusText.textContent = "Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
            }
        });

        // --- 5. ì±Œë¦°ì§€ ì‹œì‘ (Aë‹˜ì˜ 'getTodayMission' API í˜¸ì¶œ) ---
        const startChallenge = async () => {
            if (!functions) {
                statusText.textContent = "Firebase Functionsê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                return;
            }
            if (challengeSuccess) return; // ì´ë¯¸ ì„±ê³µí•¨

            statusText.textContent = "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            try {
                // Aë‹˜ì´ 'backend/functions/api/challenge.js'ì— ë§Œë“œì‹  API í˜¸ì¶œ!
                const getTodayMission = httpsCallable(functions, 'api-getTodayMission');
                const result = await getTodayMission();
                
                const mission = result.data;
                // Bë‹˜ì´ DBì— ë„£ì–´ë‘” 'Thumb_Up' ê°™ì€ ë¼ë²¨ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                missionLabel = mission.missionLabel; 
                
                // mission.missionNameì€ DBì— ì—†ì„ ê²½ìš° missionLabelì„ ì‚¬ìš©í•˜ë„ë¡ í´ë°± ì²˜ë¦¬
                missionText.textContent = `ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${mission.missionName || missionLabel} (${missionLabel})`;
                console.log("ì˜¤ëŠ˜ì˜ ë¯¸ì…˜:", missionLabel);
                
                // ì±Œë¦°ì§€ ì‹œì‘: ì›¹ìº  ì¼œê¸°
                await enableCam();

            } catch (error) {
                console.error("getTodayMission API í˜¸ì¶œ ì‹¤íŒ¨:", error);
                // Bë‹˜ì´ DBì— /config/todayMission ë¬¸ì„œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤!
                statusText.textContent = "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ë¡œë”© ì‹¤íŒ¨! (DBì— /config/todayMission ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸)";
            }
        };

        // --- 6. ì›¹ìº  ì¼œê¸° ---
        const enableCam = async () => {
            if (!gestureRecognizer) {
                // alert() ëŒ€ì‹  ìƒíƒœ í…ìŠ¤íŠ¸ ì‚¬ìš©
                statusText.textContent = "ML ëª¨ë¸ì´ ì•„ì§ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
                return;
            }
            webcamRunning = true;
            statusText.textContent = "ì›¹ìº ì„ ì¼œëŠ” ì¤‘... (ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”)";

            const constraints = { video: true };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                // ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ë¡œë“œë˜ë©´ ì˜ˆì¸¡ ì‹œì‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                video.addEventListener("loadeddata", predictWebcam);
            } catch (err) {
                console.error("ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨:", err);
                statusText.textContent = "ì›¹ìº ì„ ì¼¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¶Œí•œ í™•ì¸)";
            }
        };

        // --- 7. ì‹¤ì‹œê°„ ì˜ˆì¸¡ (MediaPipe ì‹¤í–‰) ---
        let lastVideoTime = -1;
        // ë¯¸ì…˜ ì„±ê³µì„ ìœ„í•œ ëˆ„ì  ì¹´ìš´í„° (2ì´ˆ ìœ ì§€í•´ì•¼ ì„±ê³µ)
        let successHoldFrames = 0; 
        const REQUIRED_HOLD_FRAMES = 60; // ì´ˆë‹¹ 30í”„ë ˆì„ ê¸°ì¤€ 2ì´ˆ (30 * 2)

        const predictWebcam = async () => {
            if (!webcamRunning) return;

            const nowInMs = Date.now();
            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                // ML ëª¨ë¸ì— í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ ë„£ê³  ì˜ˆì¸¡ ì‹¤í–‰
                const results = gestureRecognizer.recognizeForVideo(video, nowInMs);

                // ì˜ˆì¸¡ ê²°ê³¼ ì²˜ë¦¬
                if (results.gestures && results.gestures.length > 0) {
                    const gesture = results.gestures[0][0]; // ê°€ì¥ í™•ë¥  ë†’ì€ ì œìŠ¤ì²˜
                    currentGesture = gesture.categoryName; // ì˜ˆ: "Thumb_Up"
                    const score = (gesture.score * 100).toFixed(2);
                    currentGestureText.textContent = `í˜„ì¬ ë™ì‘: ${currentGesture} (${score}%)`;
                    
                    // ì •ë‹µê³¼ ë¹„êµ
                    checkSuccess(gesture.categoryName);

                } else {
                    currentGesture = null;
                    currentGestureText.textContent = "í˜„ì¬ ë™ì‘: (ì†ì„ ë³´ì—¬ì£¼ì„¸ìš”)";
                    successHoldFrames = 0; // ì†ì´ ì—†ìœ¼ë©´ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                }
            }
            // ë‹¤ìŒ í”„ë ˆì„ ì˜ˆì¸¡
            window.requestAnimationFrame(predictWebcam);
        };

        // --- 8. ì„±ê³µ íŒì • (Aë‹˜ì˜ 'processChallengeResult' API í˜¸ì¶œ) ---
        const checkSuccess = async (detectedGesture) => {
            if (challengeSuccess || !missionLabel) return;

            if (detectedGesture === missionLabel) {
                // ì •ë‹µ ì œìŠ¤ì²˜ê°€ ê°ì§€ë¨
                successHoldFrames++;
                statusText.textContent = `ìì„¸ ìœ ì§€ ì¤‘... ${Math.min(100, (successHoldFrames / REQUIRED_HOLD_FRAMES) * 100).toFixed(0)}%`;
                
                if (successHoldFrames >= REQUIRED_HOLD_FRAMES) {
                    // 2ì´ˆ ì´ìƒ ìœ ì§€! ì±Œë¦°ì§€ ì„±ê³µ!
                    challengeSuccess = true;
                    webcamRunning = false;
                    
                    // ì›¹ìº  ìŠ¤íŠ¸ë¦¼ ì •ì§€
                    if (video.srcObject) {
                         video.srcObject.getTracks().forEach(track => track.stop());
                    }

                    statusText.textContent = `ğŸ‰ ì±Œë¦°ì§€ ì„±ê³µ! (${missionLabel}) ì„œë²„ ì €ì¥ ì¤‘...`;
                    console.log("ì±Œë¦°ì§€ ì„±ê³µ! processChallengeResult API í˜¸ì¶œ ì‹œë„...");

                    try {
                        // Aë‹˜ì´ 'backend/functions/api/challenge.js'ì— ë§Œë“œì‹  API í˜¸ì¶œ!
                        const processChallengeResult = httpsCallable(functions, 'api-processChallengeResult');
                        const result = await processChallengeResult({ result: "success" });
                        
                        console.log("processChallengeResult API ì‘ë‹µ:", result.data);
                        statusText.textContent = `âœ… ì±Œë¦°ì§€ ì„±ê³µ! (+100 LP) ì„œë²„ì— ì €ì¥ ì™„ë£Œ!`;
                        
                        // ì‹¤ì œ ì•±ì—ì„œëŠ” ì•ŒëŒ ì„¤ì • í”Œë¡œìš°ë¡œ ì´ë™í•´ì•¼ í•¨
                        // messagebox("ë‚´ì¼ ì•ŒëŒì„ ì„¤ì •í•˜ì„¸ìš”!")

                    } catch (error) {
                        console.error("processChallengeResult API í˜¸ì¶œ ì‹¤íŒ¨:", error);
                        statusText.textContent = "âš ï¸ ì±Œë¦°ì§€ëŠ” ì„±ê³µí–ˆìœ¼ë‚˜, ì„œë²„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)";
                    }
                }
            } else {
                // ì •ë‹µ ì œìŠ¤ì²˜ê°€ ì•„ë‹˜ (ì¹´ìš´íŠ¸ ì´ˆê¸°í™”)
                successHoldFrames = 0;
            }
        };

        // --- 9. ë²„íŠ¼ì— ê¸°ëŠ¥ ì—°ê²° ---
        loginBtn.addEventListener("click", login);
        startBtn.addEventListener("click", startChallenge);

    </script>
</head>

<body class="bg-gray-900 text-white font-sans flex items-center justify-center min-h-screen">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-2xl text-center">
        <h1 class="text-4xl font-bold mb-4 text-cyan-400">PoseUp ì±Œë¦°ì§€ í…ŒìŠ¤íŠ¸</h1>
        <p class="text-gray-400 mb-6">(Aë‹˜ ë°±ì—”ë“œ API ë° MediaPipe ì—°ë™ í…ŒìŠ¤íŠ¸)</p>

        <!-- 1. ë¡œê·¸ì¸ ë²„íŠ¼ -->
        <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl">
            1. Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
        </button>

        <!-- 2. ì±Œë¦°ì§€ ì‹œì‘ ë²„íŠ¼ (ë¡œê·¸ì¸ í›„ ë³´ì„) -->
        <button id="startBtn" style="display: none;" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl">
            2. ì±Œë¦°ì§€ ì‹œì‘!
        </button>

        <!-- 3. ì›¹ìº  & ML ì˜ˆì¸¡ í™”ë©´ -->
        <div id="challengeArea" class="mt-6 p-4 bg-gray-700 rounded-lg">
            <!-- ì›¹ìº  ë¹„ë””ì˜¤ (ì¢Œìš° ë°˜ì „) -->
            <video id="webcam" class="w-full h-auto rounded-md -scale-x-100" autoplay playsinline></video>
            
            <div class="mt-4 text-left space-y-2">
                <p id="missionText" class="text-xl font-semibold text-yellow-400">ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: (ëŒ€ê¸° ì¤‘...)</p>
                <p id="currentGestureText" class="text-xl font-semibold text-orange-400">í˜„ì¬ ë™ì‘: (ì†ì„ ë³´ì—¬ì£¼ì„¸ìš”)</p>
            </div>
        </div>

        <!-- 4. ìƒíƒœ ë©”ì‹œì§€ -->
        <p id="statusText" class="mt-6 text-lg text-gray-300 bg-gray-700 p-3 rounded-md">ML ëª¨ë¸ ë¡œë“œ ì¤‘...</p>
    </div>
</body>
</html>